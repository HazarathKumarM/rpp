# The workflow tests the RPP build for HIP backend and runs rpp-performancetests

name: CICD RPP HIP

on:
  pull_request:
    branches: [ ar/opt_rmn ]

jobs:

  build:
    name: Build validation and Performance check
    runs-on: [self-hosted, Linux, X64, cpu-gpu]
    steps:
    - name: Build validation - HIP
      env:
        PR_NUMBER: ${{ github.event.pull_request.number }}
      run: |
        echo "PR#$PR_NUMBER is being verified."
        cd ~/dockerMount/abishek/github-workflows
        sudo rm -rf *
        git clone git@github.com:r-abishek/rpp.git
        cd rpp
        git checkout ar/opt_rmn
        git fetch origin pull/$PR_NUMBER/head:ar/pr
        git checkout ar/pr
        git log -3
        sudo docker exec abishek_workflows_do_not_use /bin/bash -c "cd /media/abishek/github-workflows/rpp; mkdir build; cd build; cmake -DBACKEND=HIP ..; sudo make -j20 install"
    - name: Performance check - HIP
      run: |
        sudo docker exec abishek_workflows_do_not_use /bin/bash -c "cd /media/abishek/github-workflows/rpp/utilities/rpp-performancetests/HIP_NEW; python3 generatePerformanceLogs.py --case_start 80 --case_end 80"
    - name: Performance check - HIP profiling
      run: |
        sudo docker exec abishek_workflows_do_not_use /bin/bash -c "cd /media/abishek/github-workflows/rpp/utilities/rpp-performancetests/HIP_NEW; python3 generatePerformanceLogs.py --case_start 80 --case_end 80 --profiling YES"
    - name: Compatibility check - HIP
      run: |
        echo "Skipping compatibility check."
        # echo "PR#$PR_NUMBER is being verified."
        # cd ~/dockerMount/abishek/github-workflows
        # git clone https://github.com/GPUOpen-ProfessionalCompute-Libraries/MIVisionX.git
        # cd MIVisionX
        # git log -3
        # sudo docker exec abishek_workflows_do_not_use /bin/bash -c "cd /media/abishek/github-workflows/MIVisionX; mkdir build; cd build; cmake -DBACKEND=HIP ..; sudo make -j20 install"
    - name: Clean up
      run: |
        cd ~/dockerMount/abishek/github-workflows
        sudo rm -rf *